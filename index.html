<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Squawk Messenger</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap&subset=cyrillic" rel="stylesheet">
<style>
:root{
  --bg:#0f0f10; --panel:#151515; --sidebar:#1f1f1f;
  --accent:#7c4dff; --accent-2:#6200ea; --text:#e6e6e6;
  --muted:#9a9a9a; --bubble-my:#7c4dff; --bubble-other:#333;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Montserrat',sans-serif;background:var(--bg);color:var(--text)}
.app{display:grid;grid-template-columns:300px 1fr;height:100vh;gap:0}
.sidebar{background:var(--sidebar);padding:12px;display:flex;flex-direction:column;gap:10px;position:relative}
.brand{font-weight:700;text-align:center;padding:8px 6px;border-radius:8px;background:linear-gradient(90deg,var(--panel),transparent)}
.controls{display:flex;gap:8px}
.controls input{flex:1;padding:8px;border-radius:8px;border:none;background:#111;color:var(--text)}
.controls button{padding:8px 10px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer;min-width:80px}
.menu-row{display:flex;gap:8px;align-items:center}
.menu-item{flex:1;padding:8px;border-radius:8px;background:#111;border:1px solid rgba(255,255,255,0.02);color:var(--text);cursor:pointer}

/* rooms */
.rooms{flex:1;overflow:auto;display:flex;flex-direction:column;gap:6px;padding-top:8px;-webkit-overflow-scrolling:touch}
.room-item{padding:10px;border-radius:8px;background:#2a2a2a;color:var(--text);cursor:pointer;display:flex;flex-direction:column;gap:4px;position:relative;transition:transform .18s ease,opacity .18s}
.room-item.active{background:linear-gradient(90deg, rgba(124,77,255,0.12), rgba(98,0,234,0.04));border:1px solid rgba(124,77,255,0.08)}
.room-title{font-weight:600;font-size:14px}
.room-sub{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.delete-btn{position:absolute;top:6px;right:6px;padding:4px 6px;font-size:11px;background:#e53935;border:none;color:#fff;border-radius:6px;cursor:pointer}

/* settings */
.settings-panel{display:none;flex-direction:column;gap:10px;padding-top:6px}
.setting-row{display:flex;flex-direction:column;gap:8px}
.theme-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
.theme-item{height:40px;border-radius:8px;cursor:pointer;border:2px solid transparent;display:flex;align-items:center;justify-content:center;font-size:12px;color:#000;font-weight:700}
.theme-item.active{outline:3px solid rgba(255,255,255,0.06);transform:scale(1.03)}

/* chat */
.chat-panel{display:flex;flex-direction:column;padding:16px}
.header{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--panel);border-radius:10px;position:relative;z-index:20}
.header .left { display:flex; align-items:center; gap:8px; }
#mobile_back_btn { display:none; padding:6px 10px;border-radius:8px;border:none;background:#111;color:#fff;cursor:pointer;font-weight:600 }
.chat-container{flex:1;margin-top:12px;background:#0c0c0c;padding:12px;border-radius:12px;overflow:auto;display:flex;flex-direction:column;gap:8px}
.bubble{max-width:70%;padding:10px 14px 18px 14px;border-radius:14px;margin:6px 0;font-size:14px;position:relative;word-break:break-word}
.my-msg{background:var(--bubble-my);color:#fff;align-self:flex-end;margin-left:18%;border-bottom-right-radius:6px}
.other-msg{background:var(--bubble-other);color:var(--text);align-self:flex-start;margin-right:18%;border-bottom-left-radius:6px}
.sys-msg{align-self:center;background:transparent;color:var(--muted);font-size:12px}
.bubble-body{display:block;padding-right:64px}
.bubble .bubble-time{position:absolute;font-size:11px;color:rgba(255,255,255,0.85);bottom:6px;right:8px;opacity:0.95}
.input-row{display:flex;gap:8px;margin-top:12px;align-items:center}
.input-row input[type="text"]{flex:1;padding:12px;border-radius:999px;border:none;background:#111;color:var(--text)}
.input-row button{padding:10px 14px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer;min-width:64px}
.footer{font-size:12px;color:var(--muted);text-align:center;margin-top:8px}
.no-room{display:flex;align-items:center;justify-content:center;height:60vh;color:var(--muted);font-size:16px}

/* dialog */
.dialog-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:1000}
.dialog{background:#1f1f1f;padding:20px;border-radius:12px;display:flex;flex-direction:column;gap:12px;min-width:280px;text-align:center}
.dialog button{padding:8px 14px;border-radius:6px;border:none;background:var(--accent);color:#fff;cursor:pointer}
.dialog button.cancel{background:#555;}

/* drag visuals */
.room-item.dragging{box-shadow:0 8px 20px rgba(0,0,0,0.6);opacity:0.98}
.room-item.to-delete{opacity:0.4;transform:translateY(60px) scale(.98)}

/* image styles */
.bubble img{max-width:240px;border-radius:8px;display:block;margin-top:8px}

/* mobile */
@media (max-width: 768px) {
  .app { grid-template-columns: 1fr; position:relative; }
  .sidebar {
    position: absolute;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    z-index: 100;
    transition: transform 0.28s ease;
    background: var(--sidebar);
  }
  .sidebar.hidden { transform: translateX(-100%); }
  .chat-panel {
    position: absolute;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    z-index: 50;
    transform: translateX(100%);
    transition: transform 0.28s ease;
  }
  .chat-panel.active { transform: translateX(0); }
  #mobile_back_btn { display:inline-flex; }
  .rooms { padding-top:12px; }
  .controls input { padding:12px; }
  .brand { margin-bottom:6px; }
}
</style>
</head>
<body>
<div class="app">
  <div class="sidebar" id="sidebar_el">
    <div class="brand">Squawk</div>

    <div class="controls">
      <input id="nickname_input" placeholder="–¢–≤–æ–π –Ω–∏–∫ (–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–∑–¥–Ω–æ)" />
    </div>

    <div class="menu-row">
      <button id="create_room_btn" class="menu-item">–°–æ–∑–¥–∞—Ç—å</button>
      <button id="open_settings_btn" class="menu-item">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>

    <div class="controls">
      <input id="room_code_input" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã (–∏–ª–∏ –Ω–æ–≤—ã–π)" />
      <button id="join_room_btn" class="menu-item">–í–æ–π—Ç–∏</button>
    </div>

    <div id="rooms_view">
      <div class="rooms" id="rooms_list"></div>
    </div>

    <div class="settings-panel" id="settings_panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="small-muted" id="settings_title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        <button id="settings_back" class="menu-item" style="padding:6px 8px">–ù–∞–∑–∞–¥</button>
      </div>

      <div class="setting-row">
        <div class="small-muted">–Ø–∑—ã–∫ / Language</div>
        <div style="display:flex;gap:8px">
          <button id="lang_ru" class="menu-item">RU</button>
          <button id="lang_en" class="menu-item">EN</button>
        </div>
      </div>

      <div class="setting-row">
        <div class="small-muted" id="theme_label">–¶–≤–µ—Ç–æ–≤–∞—è –≥–∞–º–º–∞</div>
        <div class="theme-grid" id="theme_grid"></div>
      </div>
    </div>

  </div>

  <div class="chat-panel" id="chat_panel_el">
    <div class="header" id="chat_header">
      <div class="left">
        <button id="mobile_back_btn">‚Üê –ß–∞—Ç—ã</button>
      </div>
      <div style="flex:1;text-align:center">
        <div class="title" id="header_title">–í—ã–±–µ—Ä–∏ —á–∞—Ç —Å–ª–µ–≤–∞</div>
      </div>
      <div style="min-width:80px;text-align:right">
        <div class="small" id="header_status">offline</div>
      </div>
    </div>

    <div class="chat-container" id="chat_container">
      <div class="no-room" id="no_room_el">–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ —á–∞—Ç–∞. –í—ã–±–µ—Ä–∏ –∫–æ–º–Ω–∞—Ç—É —Å–ª–µ–≤–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–π –Ω–æ–≤—É—é.</div>
    </div>

    <div class="input-row">
      <input type="text" id="message_input" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
      <input type="file" id="image_input" accept="image/*" style="display:none" />
      <button id="image_btn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">üì∑</button>
      <button id="send_btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
    <div class="footer" id="footer_el">SQUAWK md-09072025</div>
  </div>
</div>

<div class="dialog-overlay" id="dialog_overlay">
  <div class="dialog">
    <div id="dialog_text">–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç?</div>
    <div style="display:flex;gap:12px;justify-content:center">
      <button id="dialog_yes">–î–∞</button>
      <button id="dialog_no" class="cancel">–ù–µ—Ç</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
<script>
/* storage keys + defaults */
const LS_ROOMS = 'squawk_rooms_v1';
const LS_NICK = 'squawk_nick_v1';
const LS_LANG = 'squawk_lang_v1';
const LS_THEME = 'squawk_theme_v1';

let socket = null;
let currentRoom = null;
let myPlayerId = null;
let lang = localStorage.getItem(LS_LANG) || 'RU';
let themeId = localStorage.getItem(LS_THEME) || 'purple';

/* theme list (now includes black) */
const THEMES = [
  { id:'pink', name_ru:'–†–æ–∑–æ–≤—ã–π', name_en:'Pink', accent:'#FF64B0', accent2:'#e43d8e', bubble:'#FF64B0' },
  { id:'orange', name_ru:'–û—Ä–∞–Ω–∂–µ–≤—ã–π', name_en:'Orange', accent:'#FF8A4C', accent2:'#e06a34', bubble:'#FF8A4C' },
  { id:'red', name_ru:'–ö—Ä–∞—Å–Ω—ã–π', name_en:'Red', accent:'#FF4C4C', accent2:'#e03030', bubble:'#FF4C4C' },
  { id:'purple', name_ru:'–§–∏–æ–ª–µ—Ç–æ–≤—ã–π', name_en:'Purple', accent:'#7C4DFF', accent2:'#6200ea', bubble:'#7C4DFF' },
  { id:'blue', name_ru:'–°–∏–Ω–∏–π', name_en:'Blue', accent:'#4C6BFF', accent2:'#254bff', bubble:'#4C6BFF' },
  { id:'cyan', name_ru:'–¶–∏–∞–Ω', name_en:'Cyan', accent:'#00BCD4', accent2:'#00a4b0', bubble:'#00BCD4' },
  { id:'teal', name_ru:'–ë–∏—Ä—é–∑–æ–≤—ã–π', name_en:'Teal', accent:'#009688', accent2:'#006b63', bubble:'#009688' },
  { id:'green', name_ru:'–ó–µ–ª—ë–Ω—ã–π', name_en:'Green', accent:'#4CAF50', accent2:'#357a2e', bubble:'#4CAF50' },
  { id:'amber', name_ru:'–Ø–Ω—Ç–∞—Ä–Ω—ã–π', name_en:'Amber', accent:'#FFB300', accent2:'#d99500', bubble:'#FFB300' },
  { id:'gray', name_ru:'–°–µ—Ä—ã–π', name_en:'Gray', accent:'#607D8B', accent2:'#455a64', bubble:'#607D8B' },
  { id:'black', name_ru:'–ß—ë—Ä–Ω–∞—è', name_en:'Black', accent:'#000000', accent2:'#0a0a0a', bubble:'#0b0b0b' }
];

const LANGS = {
  RU: {
    nickname: '–¢–≤–æ–π –Ω–∏–∫',
    room_code: '–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã (–∏–ª–∏ –Ω–æ–≤—ã–π)',
    join_room_btn: '–í–æ–π—Ç–∏',
    create_room_btn: '–°–æ–∑–¥–∞—Ç—å',
    send_btn: '–û—Ç–ø—Ä–∞–≤–∏—Ç—å',
    select_chat: '–í—ã–±–µ—Ä–∏ —á–∞—Ç —Å–ª–µ–≤–∞',
    no_room: '–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ —á–∞—Ç–∞, –≤—ã–±–µ—Ä–∏ –∫–æ–º–Ω–∞—Ç—É —Å–ª–µ–≤–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–π –Ω–æ–≤—É—é',
    no_messages: '–ü–æ–∫–∞ –ø—É—Å—Ç–æ ‚Äî –Ω–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å.',
    footer: 'SQUAWK md-1.0',
    delete_confirm: '–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç?',
    delete_yes: '–î–∞',
    delete_no: '–ù–µ—Ç',
    local_room_created: '–õ–æ–∫–∞–ª—å–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞ (offline).',
    message_saved_offline: '–°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ (offline).',
    joined_room: '–í–æ—à—ë–ª –≤ –∫–æ–º–Ω–∞—Ç—É (player_id {id})',
    system_nick: 'System',
    online: '–≤ —Å–µ—Ç–∏',
    offline: '–æ—Ñ–ª–∞–π–Ω',
    settings_title: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
    theme_label: '–¶–≤–µ—Ç–æ–≤–∞—è –≥–∞–º–º–∞'
  },
  EN: {
    nickname: 'Your nickname',
    room_code: 'Room code (or new)',
    join_room_btn: 'Join',
    create_room_btn: 'Create',
    send_btn: 'Send',
    select_chat: 'Select a chat',
    no_room: 'No open chat, select a room or create a new',
    no_messages: 'Empty ‚Äî write something...',
    footer: 'SQUAWK md-1.0',
    delete_confirm: 'Are you sure you want to delete this chat?',
    delete_yes: 'Yes',
    delete_no: 'No',
    local_room_created: 'Local room created (offline).',
    message_saved_offline: 'Message saved locally (offline).',
    joined_room: 'Joined room (player_id {id})',
    system_nick: 'System',
    online: 'online',
    offline: 'offline',
    settings_title: 'Settings',
    theme_label: 'Color theme'
  }
};

/* DOM */
const roomsList = document.getElementById('rooms_list');
const chatContainer = document.getElementById('chat_container');
const headerTitle = document.getElementById('header_title');
const headerStatus = document.getElementById('header_status');
const nicknameInput = document.getElementById('nickname_input');
const roomCodeInput = document.getElementById('room_code_input');
const createRoomBtn = document.getElementById('create_room_btn');
const joinRoomBtn = document.getElementById('join_room_btn');
const sendBtn = document.getElementById('send_btn');
const messageInput = document.getElementById('message_input');
const dialogOverlay = document.getElementById('dialog_overlay');
const dialogYes = document.getElementById('dialog_yes');
const dialogNo = document.getElementById('dialog_no');
const sidebarEl = document.getElementById('sidebar_el');
const chatPanelEl = document.getElementById('chat_panel_el');
const dialogTextEl = document.getElementById('dialog_text');
const noRoomEl = document.getElementById('no_room_el');
const footerEl = document.getElementById('footer_el');
const openSettingsBtn = document.getElementById('open_settings_btn');
const settingsPanel = document.getElementById('settings_panel');
const roomsView = document.getElementById('rooms_view');
const settingsBack = document.getElementById('settings_back');
const langRU = document.getElementById('lang_ru');
const langEN = document.getElementById('lang_en');
const themeGrid = document.getElementById('theme_grid');
const mobileBackBtn = document.getElementById('mobile_back_btn');
const imageInput = document.getElementById('image_input');
const imageBtn = document.getElementById('image_btn');

nicknameInput.value = localStorage.getItem(LS_NICK) || '';

/* helpers */
function loadRooms(){ try{ return JSON.parse(localStorage.getItem(LS_ROOMS) || '[]'); }catch(e){return []} }
function saveRooms(arr){ localStorage.setItem(LS_ROOMS, JSON.stringify(arr)); }
function messagesKey(room){ return `squawk_messages_${room}_v1`; }
function loadMessages(room){ try{ return JSON.parse(localStorage.getItem(messagesKey(room)) || '[]'); }catch(e){return []} }
function saveMessages(room,arr){ localStorage.setItem(messagesKey(room), JSON.stringify(arr)); }
function saveNick(){ localStorage.setItem(LS_NICK, nicknameInput.value || 'Anon'); }
function getNick(){ return (nicknameInput.value || localStorage.getItem(LS_NICK) || 'Anon'); }
function randomCode(len=6){ const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let s=''; for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)]; return s; }
function escapeHtml(str){ return String(str || '').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }
function formatTime(ts){ if(!ts) return ''; const d=new Date(ts); return String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0'); }

/* themes */
function applyTheme(id){
  const t = THEMES.find(x=>x.id===id) || THEMES.find(x=>x.id==='purple');
  document.documentElement.style.setProperty('--accent', t.accent);
  document.documentElement.style.setProperty('--accent-2', t.accent2);
  document.documentElement.style.setProperty('--bubble-my', t.bubble);
  localStorage.setItem(LS_THEME, id);
  themeId = id;
  Array.from(document.querySelectorAll('.theme-item')).forEach(el => el.classList.toggle('active', el.dataset.id === id));
}
function renderThemeGrid(){
  themeGrid.innerHTML = '';
  THEMES.forEach(th => {
    const el = document.createElement('div');
    el.className = 'theme-item';
    el.dataset.id = th.id;
    el.title = (lang==='EN' ? th.name_en : th.name_ru);
    el.style.background = th.accent;
    el.addEventListener('click', ()=> applyTheme(th.id));
    if (th.id === themeId) el.classList.add('active');
    themeGrid.appendChild(el);
  });
}

/* more themes */
THEMES.push({
  id: 'red-contrast',
  name_ru: '–Ø—Ä–∫–æ-–∫—Ä–∞—Å–Ω–∞—è',
  name_en: 'Bright Red',
  accent: '#FF0000',
  accent2: '#CC0000',
  bubble: '#FF1A1A'
});

THEMES.push({
  id: 'red-dark',
  name_ru: '–¢—ë–º–Ω–æ-–∫—Ä–∞—Å–Ω–∞—è',
  name_en: 'Dark Red',
  accent: '#8B0000',
  accent2: '#660000',
  bubble: '#4B0000'
});

function ensureMobileBackButton(){
  if (window.innerWidth <= 768){
    mobileBackBtn.style.display = 'inline-flex';
    mobileBackBtn.textContent = '‚Üê ' + (lang === 'EN' ? 'Rooms' : '–ß–∞—Ç—ã');
  } else {
    mobileBackBtn.style.display = 'none';
    sidebarEl.classList.remove('hidden');
    chatPanelEl.classList.remove('active');
  }
}
window.addEventListener('resize', ensureMobileBackButton);
window.addEventListener('orientationchange', ensureMobileBackButton);

/* rooms rendering */
function addOrUpdateRoom(code, opts={}) {
  const rooms = loadRooms();
  const idx = rooms.findIndex(r=>r.code===code);
  const now = Date.now();
  if (idx === -1) rooms.unshift({ code, name: opts.name || code, lastText: opts.lastText || '', lastTs: opts.lastTs || now });
  else {
    rooms[idx].lastText = opts.lastText || rooms[idx].lastText;
    rooms[idx].lastTs = opts.lastTs || rooms[idx].lastTs;
    const r = rooms.splice(idx,1)[0];
    rooms.unshift(r);
  }
  saveRooms(rooms);
  renderRooms();
}
function deleteRoom(code){
  let rooms = loadRooms();
  rooms = rooms.filter(r=>r.code!==code);
  saveRooms(rooms);
  localStorage.removeItem(messagesKey(code));
  if (currentRoom === code){
    currentRoom = null;
    chatContainer.innerHTML = `<div class="no-room">${LANGS[lang].no_room}</div>`;
    headerTitle.textContent = LANGS[lang].select_chat;
  }
  renderRooms();
}
function renderRooms(){
  const rooms = loadRooms();
  roomsList.innerHTML = '';
  if (!rooms.length){
    roomsList.innerHTML = `<div class="small">${LANGS[lang].no_room}</div>`;
    return;
  }
  rooms.forEach(r=>{
    const item = document.createElement('div');
    item.className = 'room-item' + (currentRoom === r.code ? ' active' : '');
    item.dataset.code = r.code;
    item.innerHTML = `<div class="room-title">${escapeHtml(r.name)}</div><div class="room-sub">${escapeHtml(r.lastText||'')}</div><button class="delete-btn">${LANGS[lang].delete_yes}</button>`;
    item.addEventListener('click', ()=> { if (item.classList.contains('dragging')) return; openRoom(r.code); });
    item.querySelector('.delete-btn').addEventListener('click', ev=>{ ev.stopPropagation(); promptDelete(r.code); });

    let startY=0, curY=0, dragging=false; const threshold=80;
    function onStart(e){ dragging=true; item.classList.add('dragging'); startY=(e.touches?e.touches[0].clientY:e.clientY); curY=0; }
    function onMove(e){ if(!dragging) return; const y=(e.touches?e.touches[0].clientY:e.clientY); curY=y-startY; if (curY<0) curY=0; if (e.cancelable) e.preventDefault(); item.style.transform=`translateY(${curY}px)`; if(curY>threshold) item.classList.add('to-delete'); else item.classList.remove('to-delete'); }
    function onEnd(){ dragging=false; item.classList.remove('dragging'); item.style.transition='transform .18s ease'; if (curY>threshold){ item.style.transform='translateY(60px)'; item.classList.add('to-delete'); setTimeout(()=>{ item.style.transform=''; item.classList.remove('to-delete'); },180); promptDelete(r.code); } else { item.style.transform=''; } setTimeout(()=>{ item.style.transition=''; },200); }

    item.addEventListener('touchstart', onStart, {passive:false});
    item.addEventListener('touchmove', onMove, {passive:false});
    item.addEventListener('touchend', onEnd);
    item.addEventListener('mousedown', (e)=>{ if(e.button!==0) return; onStart(e); const onDocMove=(ev)=>onMove(ev); const onDocUp=()=>{ onEnd(); document.removeEventListener('mousemove', onDocMove); document.removeEventListener('mouseup', onDocUp); }; document.addEventListener('mousemove', onDocMove); document.addEventListener('mouseup', onDocUp); });

    roomsList.appendChild(item);
  });
}

/* delete confirm */
let pendingDelete = null;
function promptDelete(code){
  pendingDelete = code;
  dialogTextEl.textContent = LANGS[lang].delete_confirm;
  dialogYes.textContent = LANGS[lang].delete_yes;
  dialogNo.textContent = LANGS[lang].delete_no;
  dialogOverlay.style.display = 'flex';
}
dialogNo.addEventListener('click', ()=>{ dialogOverlay.style.display='none'; pendingDelete=null; });
dialogYes.addEventListener('click', ()=>{ if(pendingDelete) deleteRoom(pendingDelete); dialogOverlay.style.display='none'; pendingDelete=null; });

/* messages */
function renderMessagesForRoom(room){
  const msgs = loadMessages(room);
  chatContainer.innerHTML = '';
  if (!msgs.length){ chatContainer.innerHTML = `<div class="no-room">${LANGS[lang].no_messages}</div>`; return; }
  msgs.forEach(m=>{
    if (m.system){
      const d=document.createElement('div'); d.className='sys-msg'; d.textContent=m.text; chatContainer.appendChild(d);
    } else {
      const d=document.createElement('div'); d.className='bubble ' + (m.me ? 'my-msg' : 'other-msg');
      const time = m.ts ? formatTime(m.ts) : '';
      if (m.type === 'image'){
        const url = m.url || '';
        d.innerHTML = `<div class="bubble-body"><strong>${escapeHtml(m.nickname)}:</strong><br/><img src="${escapeHtml(url)}" loading="lazy" alt="image" onerror="this.style.opacity=0.6;this.title='–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'" /></div><div class="bubble-time">${time}</div>`;
      } else {
        d.innerHTML = `<div class="bubble-body"><strong>${escapeHtml(m.nickname)}:</strong> <span class="bubble-text">${escapeHtml(m.text)}</span></div><div class="bubble-time">${time}</div>`;
      }
      chatContainer.appendChild(d);
    }
  });
  chatContainer.scrollTop = chatContainer.scrollHeight;
}
function isDuplicate(room,msg){
  const arr=loadMessages(room); if(!arr.length) return false;
  const last=arr[arr.length-1]; if(!last) return false;
  if (msg.type === 'image') return (last.type === 'image' && String(last.url) === String(msg.url) && String(last.nickname) === String(msg.nickname));
  return (last.type !== 'image' && String(last.text)===String(msg.text) && String(last.nickname)===String(msg.nickname));
}
function pushMessage(room,msg){ if(!room) return; if(isDuplicate(room,msg)) return; const arr=loadMessages(room); arr.push(msg); saveMessages(room,arr); addOrUpdateRoom(room,{ lastText: msg.system? ('[SYS] '+msg.text) : (msg.type === 'image' ? '[IMAGE]' : msg.text), lastTs: msg.ts }); if (currentRoom===room) renderMessagesForRoom(room); }

/* socket */
function ensureSocket(){
  if (socket) return;
  try {
    socket = io((location.hostname==='localhost' || location.hostname==='127.0.0.1') ? 'http://localhost:5000' : 'https://squawkmessenger.onrender.com', { transports: ['websocket'] });
  } catch(e){ socket=null; console.warn('socket init failed', e); }
  if(!socket) return;
  socket.on('connect', ()=>{ headerStatus.textContent = LANGS[lang].online; if (currentRoom) socket.emit('join_room', { nickname: getNick(), room_code: currentRoom }); });
  socket.on('disconnect', ()=>{ headerStatus.textContent = LANGS[lang].offline; myPlayerId=null; });
  socket.on('joined_room', data=>{ myPlayerId=data.player_id; pushMessage(currentRoom, { nickname: LANGS[lang].system_nick, text: LANGS[lang].joined_room.replace('{id}', myPlayerId), ts: Date.now(), system:true, me:false }); });
  socket.on('receive_message', data=>{
    // ignore own echo if server returns it with same player_id
    if (data.player_id && myPlayerId && data.player_id===myPlayerId) return;
    const type = data.type || 'text';
    if (type === 'image'){
      pushMessage(currentRoom, { type:'image', nickname: data.nickname, url: data.url, ts: Date.now(), system:false, me:false });
    } else {
      pushMessage(currentRoom, { type:'text', nickname: data.nickname, text: data.text, ts: Date.now(), system:false, me:false });
    }
  });
  socket.on('system_message', data=>{ pushMessage(currentRoom, { nickname: LANGS[lang].system_nick, text: data.text, ts: Date.now(), system:true, me:false }); });
}

/* open room */
function openRoom(code){
  currentRoom = code;
  renderRooms();
  headerTitle.textContent = code;
  headerStatus.textContent = LANGS[lang].offline;
  renderMessagesForRoom(code);
  ensureSocket();
  if (socket && socket.connected) socket.emit('join_room', { nickname: getNick(), room_code: code });
  if (window.innerWidth <= 768){ sidebarEl.classList.add('hidden'); chatPanelEl.classList.add('active'); }
}

/* send text */
function sendTextMessage(){
  const text = messageInput.value.trim();
  if (!currentRoom || !text) return;
  const msg = { type:'text', nickname: getNick(), text, ts: Date.now(), system:false, me:true };
  pushMessage(currentRoom, msg);
  if (socket && socket.connected){
    socket.emit('send_message', { type:'text', text, player_id: myPlayerId, room_code: currentRoom });
  } else {
    pushMessage(currentRoom, { nickname: LANGS[lang].system_nick, text: LANGS[lang].message_saved_offline, ts: Date.now(), system:true, me:false });
  }
  messageInput.value='';
}

/* image upload + send */
function uploadAndSendImage(file){
  if (!currentRoom || !file) return;
  const base = (location.hostname==='localhost' || location.hostname==='127.0.0.1') ? 'http://localhost:5000' : 'https://squawkmessenger.onrender.com';
  const formData = new FormData();
  formData.append('file', file);

  // optimistic UI: add preview locally before upload completes
  const tempUrl = URL.createObjectURL(file);
  const optimisticMsg = { type:'image', nickname: getNick(), url: tempUrl, ts: Date.now(), system:false, me:true };
  pushMessage(currentRoom, optimisticMsg);

  fetch(base + '/upload_image', {
    method: 'POST',
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    const imageUrl = data.url;
    // replace optimistic message with real one: store real message
    pushMessage(currentRoom, { type:'image', nickname: getNick(), url: imageUrl, ts: Date.now(), system:false, me:true });
    // notify server to broadcast
    if (socket && socket.connected){
      socket.emit('send_message', { type:'image', url: imageUrl, player_id: myPlayerId, room_code: currentRoom });
    } else {
      pushMessage(currentRoom, { nickname: LANGS[lang].system_nick, text: LANGS[lang].message_saved_offline, ts: Date.now(), system:true, me:false });
    }
  })
  .catch(err => {
    console.error('Upload error:', err);
    pushMessage(currentRoom, { nickname: LANGS[lang].system_nick, text: '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', ts: Date.now(), system:true, me:false });
  })
  .finally(()=>{ URL.revokeObjectURL(tempUrl); });

  imageInput.value = '';
}

/* UI events */
sendBtn.addEventListener('click', sendTextMessage);
messageInput.addEventListener('keydown', e=>{ if(e.key==='Enter') sendTextMessage(); });

imageBtn.addEventListener('click', ()=> imageInput.click());
imageInput.addEventListener('change', ()=> {
  const file = imageInput.files[0];
  if (!file) return;
  // basic client-side size/type checks
  if (!file.type.startsWith('image/')) { alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.'); imageInput.value=''; return; }
  // optional: limit size (e.g. 6MB)
  const maxSize = 6 * 1024 * 1024;
  if (file.size > maxSize) { alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å 6MB).'); imageInput.value=''; return; }
  uploadAndSendImage(file);
});

/* create/join */
createRoomBtn.addEventListener('click', ()=>{
  const nick = getNick(); saveNick();
  const desired = (roomCodeInput.value || randomCode()).toUpperCase();
  const base = (location.hostname==='localhost' || location.hostname==='127.0.0.1') ? 'http://localhost:5000' : 'https://squawkmessenger.onrender.com';
  fetch(base + '/create_room', { method: 'POST' }).then(r=>r.json()).then(data=>{
    const code = data.room_code || desired;
    addOrUpdateRoom(code, { name: code, lastText:'', lastTs: Date.now() });
    openRoom(code);
  }).catch(err=>{
    const code = desired;
    addOrUpdateRoom(code, { name: code, lastText: '(' + LANGS[lang].local_room_created + ')', lastTs: Date.now() });
    pushMessage(code, { nickname: LANGS[lang].system_nick, text: LANGS[lang].local_room_created, ts: Date.now(), system:true, me:false });
    openRoom(code);
  });
});
joinRoomBtn.addEventListener('click', ()=> {
  const code = (roomCodeInput.value || '').toUpperCase();
  if (!code) return;
  saveNick();
  addOrUpdateRoom(code, { name: code, lastText: '(' + LANGS[lang].join_room_btn + ')', lastTs: Date.now() });
  openRoom(code);
});

/* settings UI */
openSettingsBtn.addEventListener('click', ()=>{ roomsView.style.display='none'; settingsPanel.style.display='flex'; });
settingsBack.addEventListener('click', ()=>{ settingsPanel.style.display='none'; roomsView.style.display=''; });

/* language */
langRU.addEventListener('click', ()=>{ lang='RU'; localStorage.setItem(LS_LANG, lang); updateLang(); });
langEN.addEventListener('click', ()=>{ lang='EN'; localStorage.setItem(LS_LANG, lang); updateLang(); });

/* update lang */
function updateLang(){
  const t = LANGS[lang];
  nicknameInput.placeholder = t.nickname;
  roomCodeInput.placeholder = t.room_code;
  joinRoomBtn.textContent = t.join_room_btn;
  createRoomBtn.textContent = t.create_room_btn;
  sendBtn.textContent = t.send_btn;
  headerTitle.textContent = currentRoom || t.select_chat;
  noRoomEl.textContent = t.no_messages;
  dialogTextEl.textContent = t.delete_confirm;
  dialogYes.textContent = t.delete_yes;
  dialogNo.textContent = t.delete_no;
  headerStatus.textContent = t.offline;
  footerEl.textContent = t.footer;
  document.getElementById('settings_title').textContent = t.settings_title;
  document.getElementById('theme_label').textContent = t.theme_label;
  ensureMobileBackButton();
  renderThemeGrid();
}

/* init on DOM ready ‚Äî attach mobile back click handler reliably */
document.addEventListener('DOMContentLoaded', ()=>{
  mobileBackBtn.addEventListener('click', ()=>{
    sidebarEl.classList.remove('hidden');
    chatPanelEl.classList.remove('active');
  });

  renderThemeGrid();
  applyTheme(themeId);
  renderRooms();
  updateLang();

  const rooms = loadRooms();
  if (rooms && rooms.length>0) setTimeout(()=> openRoom(rooms[0].code), 200);

  nicknameInput.addEventListener('change', saveNick);
  roomsList.addEventListener('touchmove', (e)=>{}, { passive:true });
  ensureMobileBackButton();
});
</script>
</body>
</html>
